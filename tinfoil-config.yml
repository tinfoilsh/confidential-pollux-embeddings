shim-version: v0.3.5@sha256:f44c65a1f7db476be20c3431bb6facea8c2966606a07fbb5724a619f82bfa558
cvm-version: 0.5.15
cpus: 16
memory: 65536
gpus: full

containers:
  - name: "ml-embeddings"
    image: ""
    args: [
      "--runtime", "nvidia",
      "--gpus", "all",
      "--ipc", "host",
      "--cap-add", "SYS_ADMIN",
      "--device", "/dev/fuse",
      "--security-opt", "apparmor=unconfined",
      "-v", "/mnt/ramdisk/gcloud_key.json:/key.json:ro",
      "-e", "GOOGLE_APPLICATION_CREDENTIALS=/key.json",
      "-e", "GCS_BUCKET=pollux-enc-prod",
      "-e", "POLLUX_LN_GCS_BUCKET=gs://pollux-enc-prod",
      "-e", "KEY_MODE=real_keys",
      "-e", "DATABASE_URL=$(sed -n 's/^DATABASE_URL: *//p' /mnt/ramdisk/external-config.yml)",
      "-e", "GOOGLE_CLIENT_ID=$(sed -n 's/^GOOGLE_CLIENT_ID: *//p' /mnt/ramdisk/external-config.yml)",
      "-e", "GOOGLE_CLIENT_SECRET=$(sed -n 's/^GOOGLE_CLIENT_SECRET: *//p' /mnt/ramdisk/external-config.yml)",
      "-e", "TINFOIL_API_KEY=$(sed -n 's/^TINFOIL_API_KEY: *//p' /mnt/ramdisk/external-config.yml)",
      "-e", "HF_TOKEN=$(sed -n 's/^HF_TOKEN: *//p' /mnt/ramdisk/external-config.yml)",
      "us-central1-docker.pkg.dev/workshop-labs-pbc/pollux-docker/ml-embeddings@sha256:774abc316fef8aef52395e4ad133a5a1372d74bcc298d888185849a8ae14a9ac",
      "--prod"
    ]

shim:
  listen-port: 443
  upstream-port: 8000
  publish-attestation: true
  tls-challenge: dns
  paths:
    - /ping
    - /set_dek
    - /v1/search
    - /v1/file/{file_id}
    - /v1/db/users
    - /v1/db/files
    - /v1/metrics
    - /v1/stats
    - /v1/user/*
